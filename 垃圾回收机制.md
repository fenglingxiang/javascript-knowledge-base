## 垃圾回收机制

垃圾回收机制是一种自动管理内存的机制，为了防止内存泄露。现代浏览器主要采用分代回收策略，结合标记-清除、标记-整理等算法，V8 引擎还引入了增量标记和并发回收来优化性能。

垃圾回收机制主要有三种基础算法：

1. 引用计数法：当一个对象被引用时，计数器 +1，当一个对象不被引用时，计数器 -1，当计数器为 0 时，该对象被回收。

- 优点: 立即回收，没有暂停时间
- 缺点：无法处理循环引用问题

```js
let objA = { a: 1 }; // objA 的引用计数+1, 总计为 1
let objB = objA; // objA 的引用计数+1，总计为 2
objA = null; // objA 的引用计数-1，总计为 1 不会被回收
```

2. 标记-清除法：在标记阶段从根对象开始，优先深度遍历可达对象并标记，在清除阶段，将未标记的对象清除。

- 优点：可以处理循环引用问题
- 缺点：清除后会产生内存碎片，需要整理

3. 标记-整理法：是对标记-清除法的优化，在整理阶段会将存活的对象移动到内存的一端，更新对移动对象的引用。

- 优点：可以处理循环引用问题，不会产生内存碎片
- 缺点：需要移动对象开销大，暂停时间更长

### V8 引擎的分代回收策略

将内存分为新生代和老生代

- 新生代：大小为 1-8MB，存活时间较短的对象，采用复制算法
  - 复制算法是将堆内存一分为二，分别是 From 空间和 To 空间，将存货的对象从 From 空间复制到 To 空间，然后 From 空间和 To 空间互换。经历一次垃圾回收的对象晋升到老生代
- 老生代：大小为几百 MB 到 1.4GB，存活时间较长的对象，采用标记-清除、标记-整理算法
  - 主要是采用标记-清除算法，当内存碎片化严重时才会触发标记-整理算法优化内存

为了减少垃圾回收的暂停时间， V8 引擎引入增量标记和并发回收

- 增量标记是将标记过程拆分为多个小步骤，每次执行完一小步就让主线程执行一会，然后执行下一小步，交替执行直到标记结束
- 并发回收是将标记过程放到后台线程执行，主线程继续执行，当标记结束后，主线程暂停，后台线程继续执行，直到后台线程执行结束，主线程继续执行
